<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸŽ‰ Dashboard - Birthday App</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
   <div class="planet blue"></div>
<div class="planet purple"></div>
  <!-- â˜„ï¸ Comets -->
<div class="comet comet-1"></div>
<div class="comet comet-2"></div>
<div class="comet comet-3"></div>
<div class="comet comet-4"></div>
<div class="comet comet-5"></div>

  <div class="container">
    <h2>Welcome, <span id="userName"></span> ðŸŽˆ</h2>
    <p>Your birthday: <span id="userBirthday"></span></p>

    <div id="todayBirthday" style="margin-top: 1rem; color: #b46cf3; font-weight: bold;"></div>
    
    <h3>ðŸ“… Upcoming Birthdays (Next 7 Days)</h3>
    <ul id="upcomingBirthdays"></ul>

    <h3>Add a Friend</h3>
    <form id="addFriendForm">
      <input type="email" name="friendEmail" placeholder="Friend's Email" required />
      <button type="submit">Send Friend Request</button>
    </form>

    <h3>Friend Requests</h3>
    <ul id="friendRequests"></ul>

    <h3>Find People</h3>
    <input type="text" id="searchInput" placeholder="Search by name or email" />
    <ul id="searchResults"></ul>

    <h3>Your Friends</h3>
    <ul id="friendsList"></ul>

    <h3>ðŸ’Œ Send Birthday Invite</h3>
    <form id="inviteForm">
      <select name="invitee" id="inviteeSelect" required></select>
      <input type="date" name="date" required />
      <input type="time" name="time" required />
      <input type="text" name="place" placeholder="Place" required />
      <textarea name="message" placeholder="Optional message"></textarea>
      <button type="submit">Generate Invite</button>
    </form>
    <div id="invitePreview"></div>

    <button onclick="logout()" style="margin-top: 1.5rem;">Logout</button>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";

    document.getElementById("userName").textContent = user.name;
    document.getElementById("userBirthday").textContent = user.birthday;

    const friendsListEl = document.getElementById("friendsList");
    const inviteeSelect = document.getElementById("inviteeSelect");
    const upcomingList = document.getElementById("upcomingBirthdays");
    const friendRequestsEl = document.getElementById("friendRequests");
    const searchInput = document.getElementById("searchInput");
    const searchResultsEl = document.getElementById("searchResults");
    let friendsData = [];

    async function fetchFriends() {
      const res = await fetch(`https://birthday-project-ncca.onrender.com/friends?email=${user.email}`);
      friendsData = await res.json();

      friendsListEl.innerHTML = "";
      inviteeSelect.innerHTML = "<option value='' disabled selected>Select friend</option>";
      upcomingList.innerHTML = "";

      const today = new Date().toISOString().slice(5, 10); // MM-DD
      let todayMessage = "";

      friendsData.forEach(f => {
        // Friend list
        const li = document.createElement("li");
        li.textContent = `${f.name} ðŸŽ‚ ${f.birthday}`;
        friendsListEl.appendChild(li);

        // Invite dropdown
        const opt = document.createElement("option");
        opt.value = f.name;
        opt.textContent = f.name;
        inviteeSelect.appendChild(opt);

        // Birthday Today
        if (f.birthday.slice(5, 10) === today) {
          todayMessage += `ðŸŽ‰ It's ${f.name}'s Birthday Today!\n`;
        }

        // Upcoming Birthdays
        const bday = new Date(f.birthday);
        const now = new Date();
        bday.setFullYear(now.getFullYear());

        const diffDays = Math.floor((bday - now) / (1000 * 60 * 60 * 24));
        if (diffDays >= 1 && diffDays <= 7) {
          const upcomingLi = document.createElement("li");
          upcomingLi.textContent = `${f.name} - ${bday.toDateString()}`;
          upcomingList.appendChild(upcomingLi);
        }
      });

      if (todayMessage) {
        document.getElementById("todayBirthday").textContent = todayMessage.trim();
      }
    }

    async function fetchFriendRequests() {
      const res = await fetch(`https://birthday-project-ncca.onrender.com/friend-requests?email=${user.email}`);
      const requests = await res.json();

      friendRequestsEl.innerHTML = "";

      requests.forEach(req => {
        const li = document.createElement("li");
        li.textContent = `${req.from.name} (${req.from.email}) wants to be your friend`;

        const acceptBtn = document.createElement("button");
        acceptBtn.textContent = "Accept";
        acceptBtn.onclick = () => respondToRequest(req._id, "accept");

        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "Reject";
        rejectBtn.onclick = () => respondToRequest(req._id, "reject");

        li.appendChild(acceptBtn);
        li.appendChild(rejectBtn);
        friendRequestsEl.appendChild(li);
      });
    }

    async function respondToRequest(id, action) {
      const res = await fetch("https://birthday-project-ncca.onrender.com/friend-request/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ requestId: id, action })
      });
      const result = await res.json();
      alert(result.message);
      fetchFriendRequests();
      fetchFriends();
    }

    async function searchUsers(query) {
      if (!query || query.trim() === "") {
        searchResultsEl.innerHTML = "";
        return;
      }

      const res = await fetch(`https://birthday-project-ncca.onrender.com/search-users?q=${encodeURIComponent(query)}`);
      const users = await res.json();

      searchResultsEl.innerHTML = "";
      users.forEach(u => {
        const li = document.createElement("li");
        li.textContent = `${u.name} (${u.email}) ðŸŽ‚ ${u.birthday}`;
        searchResultsEl.appendChild(li);
      });
    }

    fetchFriends();
    fetchFriendRequests();

    searchInput.addEventListener("input", (e) => {
      searchUsers(e.target.value);
    });

    document.getElementById("addFriendForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const friendEmail = e.target.friendEmail.value;

      const res = await fetch("https://birthday-project-ncca.onrender.com/friend-request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fromEmail: user.email, toEmail: friendEmail })
      });

      const result = await res.json();
      alert(result.message);
      fetchFriends();
    });

    document.getElementById("inviteForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const name = form.invitee.value;
      const date = form.date.value;
      const time = form.time.value;
      const place = form.place.value;
      const msg = form.message.value;

      // Preview
      const html = `
        <div style='margin-top: 1rem; border: 1px solid #ccc; padding: 1rem; border-radius: 10px;'>
          <h4>You're Invited ðŸŽ‰</h4>
          <p><strong>To:</strong> ${name}</p>
          <p><strong>Date:</strong> ${date}</p>
          <p><strong>Time:</strong> ${time}</p>
          <p><strong>Place:</strong> ${place}</p>
          ${msg ? `<p><strong>Message:</strong> ${msg}</p>` : ""}
        </div>
      `;
      document.getElementById("invitePreview").innerHTML = html;

      // Send Invite to backend
      await fetch('https://birthday-project-ncca.onrender.com/send-invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ from: user.email, to: name, date, time, place, message: msg })
      });
    });

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
